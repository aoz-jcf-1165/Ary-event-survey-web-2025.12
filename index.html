// tsc-survey-api - Cloudflare Worker (stable)
// JSON を受け取り、GitHub Issues に保存（キー名をCSV側と完全一致させる）
// 追加: 同一 player_name の古い Issue を close して「上書き」運用も可能

const GITHUB_REPO = "aoz-jcf-1165/TSC-event-survey-web-2025.12";

function corsHeaders() {
  return {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
  };
}

function jsonResp(obj, status = 200) {
  return new Response(JSON.stringify(obj), {
    status,
    headers: { ...corsHeaders(), "Content-Type": "application/json" },
  });
}

function normalizeText(v) {
  if (v == null) return "";
  return String(v).trim();
}

async function ghFetch(url, env, options = {}) {
  const res = await fetch(url, {
    ...options,
    headers: {
      Authorization: `Bearer ${env.GITHUB_TOKEN}`,
      Accept: "application/vnd.github+json",
      "Content-Type": "application/json",
      "User-Agent": "tsc-survey-worker",
      ...(options.headers || {}),
    },
  });
  return res;
}

export default {
  async fetch(request, env, ctx) {
    if (request.method === "OPTIONS") {
      return new Response("", { status: 204, headers: corsHeaders() });
    }
    if (request.method !== "POST") {
      return jsonResp({ ok: false, error: "Use POST only." }, 405);
    }

    let payload;
    try {
      payload = await request.json();
    } catch {
      return jsonResp({ ok: false, error: "Invalid JSON" }, 400);
    }

    const timestamp = normalizeText(payload?.timestamp) || new Date().toISOString();
    const language = normalizeText(payload?.language);
    const player_name = normalizeText(payload?.player_name);

    // フロントは Q02_time/Q03_time/Q04_day を送ってくる前提
    // ただし念のため別名も吸_ALLOWED
    const Q2_time =
      normalizeText(payload?.Q2_time) ||
      normalizeText(payload?.Q02_time) ||
      normalizeText(payload?.q02) ||
      "";
    const Q3_time =
      normalizeText(payload?.Q3_time) ||
      normalizeText(payload?.Q03_time) ||
      normalizeText(payload?.q03) ||
      "";
    const Q4_day =
      normalizeText(payload?.Q4_day) ||
      normalizeText(payload?.Q04_day) ||
      normalizeText(payload?.q04) ||
      "";

    if (!player_name) {
      return jsonResp({ ok: false, error: "player_name is required" }, 400);
    }

    const issueTitle = `Survey response from: ${player_name}`;

    // ★ここが重要：Actions が読むキー名と完全一致させる
    const issueBody = [
      "| Field | Value |",
      "| --- | --- |",
      `| timestamp | ${timestamp} |`,
      `| language | ${language} |`,
      `| player_name | ${player_name} |`,
      `| Q2_time | ${Q2_time} |`,
      `| Q3_time | ${Q3_time} |`,
      `| Q4_day | ${Q4_day} |`,
      "",
      "_Generated automatically from Cloudflare Worker._",
    ].join("\n");

    try {
      // --- 任意：同一 player_name の古い Issue を close（= 上書き運用） ---
      // これを有効にしたい場合は true にしてください
      const CLOSE_OLD_ISSUES = true;

      if (CLOSE_OLD_ISSUES) {
        // open issue を検索（タイトル完全一致）
        const listUrl = `https://api.github.com/repos/${GITHUB_REPO}/issues?state=open&per_page=100`;
        const listRes = await ghFetch(listUrl, env, { method: "GET" });
        if (listRes.ok) {
          const issues = await listRes.json();
          const targets = issues.filter((it) => it?.title === issueTitle);
          // 既存があれば close（最新を作る前に閉じる）
          for (const it of targets) {
            await ghFetch(`https://api.github.com/repos/${GITHUB_REPO}/issues/${it.number}`, env, {
              method: "PATCH",
              body: JSON.stringify({ state: "closed" }),
            });
          }
        }
      }

      // --- Issue 作成 ---
      const createRes = await ghFetch(
        `https://api.github.com/repos/${GITHUB_REPO}/issues`,
        env,
        {
          method: "POST",
          body: JSON.stringify({ title: issueTitle, body: issueBody }),
        }
      );

      if (!createRes.ok) {
        const errorText = await createRes.text();
        return jsonResp(
          { ok: false, githubStatus: createRes.status, githubBody: errorText },
          502
        );
      }

      const ghData = await createRes.json();
      return jsonResp({ ok: true, issueNumber: ghData.number }, 200);
    } catch (err) {
      return jsonResp({ ok: false, error: String(err) }, 500);
    }
  },
};
