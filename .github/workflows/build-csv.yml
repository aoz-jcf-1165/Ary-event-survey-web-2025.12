name: Build Survey CSV

on:
  issues:
    types: [opened, edited]
  workflow_dispatch:

jobs:
  build_csv:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI & jq
        run: |
          sudo apt update
          sudo apt install -y jq
          type -p gh >/dev/null || curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          sudo apt install -y gh

      - name: Read GitHub Issues and generate CSV
        id: generate_csv
        run: |
          echo "timestamp,player,lang,Q2_1,Q2_2,Q3_1,Q3_2" > survey.csv

          gh issue list --state all --json number,title,body,createdAt > issues.json

          cat issues.json | jq -r '
            .[] |
            .body as $body |
            $body |
            split("\n") |
            map(sub("\r";"")) |
            {
              timestamp: (.[0] | split(": ")[1]),
              player: (.[1] | split(": ")[1]),
              lang: (.[2] | split(": ")[1]),
              Q2_1: (.[3] | split(": ")[1]),
              Q2_2: (.[4] | split(": ")[1]),
              Q3_1: (.[5] | split(": ")[1]),
              Q3_2: (.[6] | split(": ")[1])
            } |
            [.timestamp, .player, .lang, .Q2_1, .Q2_2, .Q3_1, .Q3_2] |
            @csv
          ' >> survey.csv

      - name: Commit survey.csv
        run: |
          mkdir -p data
          mv survey.csv data/survey.csv
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add data/survey.csv
          git commit -m "Auto update survey CSV" || echo "No changes"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
