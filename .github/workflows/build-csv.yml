name: Build Survey CSV (Ary)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"   # UTC 18:00 → JST 翌日 03:00

jobs:
  rebuild:
    runs-on: ubuntu-latest

    concurrency:
      group: ary-survey-csv
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebuild data/survey.csv from OPEN issues only (latest per player)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const headers = [
              "timestamp",
              "language",
              "player_name",
              "Q2_time",
              "Q3_time",
              "Q4_day",
            ];

            const ALLOWED_LANGS = new Set([
              "en","de","nl","fr","ru","es","pt","it",
              "zh-hans","ja","ko","zh-hant","ar","th",
              "vi","tr","pl","ms","id"
            ]);

            function escapeCSV(v){
              if(v==null) return "";
              const s=String(v);
              return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
            }

            function normalizeLang(v){
              const s=(v||"").trim().toLowerCase();
              if(!s) return "en";
              if(s==="zh") return "zh-hans";
              return ALLOWED_LANGS.has(s)?s:"en";
            }

            function parseSurveyJson(body){
              const m = body.match(/<!--SURVEY_JSON-->[\s\S]*?```json\s*([\s\S]*?)\s*```/i);
              if(!m) return null;
              try{ return JSON.parse(m[1]); }catch{ return null; }
            }

            function parseKV(body){
              const map={};
              (body||"").split(/\r?\n/).forEach(l=>{
                let m=l.match(/^\s*([A-Za-z0-9_]+)\s*:\s*(.*?)\s*$/);
                if(m) map[m[1]]=m[2];
              });
              return map;
            }

            function toRow(o,issue){
              if(!o) return null;
              const row={
                timestamp:o.timestamp||issue.created_at,
                language:normalizeLang(o.language),
                player_name:(o.player_name||"").trim(),
                Q2_time:o.Q2_time||"",
                Q3_time:o.Q3_time||"",
                Q4_day:o.Q4_day||"",
              };
              return row.player_name?row:null;
            }

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state:"open", per_page:100 }
            );

            const latest=new Map();

            for(const issue of issues){
              if(issue.pull_request) continue;
              const labels=(issue.labels||[]).map(l=>l.name.toLowerCase());
              if(!labels.includes("survey")) continue;

              const body=issue.body||"";
              const obj=parseSurveyJson(body)||parseKV(body);
              const row=toRow(obj,issue);
              if(!row) continue;

              const t=new Date(issue.created_at);
              const prev=latest.get(row.player_name);
              if(!prev||t>prev.t) latest.set(row.player_name,{t,row});
            }

            const rows=[...latest.values()].sort((a,b)=>a.t-b.t).map(x=>x.row);

            fs.mkdirSync("data",{recursive:true});
            let csv=headers.join(",");
            if(rows.length){
              csv+="\n"+rows.map(r=>headers.map(h=>escapeCSV(r[h])).join(",")).join("\n");
            }
            csv+="\n";
            fs.writeFileSync("data/survey.csv",csv,"utf8");
