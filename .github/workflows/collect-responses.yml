name: collect

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch: {}

permissions:
  contents: write
  issues: read

concurrency:
  group: collect
  cancel-in-progress: true

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Append CSV from issue (label: survey)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const issue = context.payload.issue;
            if (!issue) {
              core.info("No issue payload (manual run). Exiting.");
              return;
            }

            const labels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));
            if (!labels.includes("survey")) {
              core.info("Issue has no 'survey' label. Skipping.");
              return;
            }

            const body = issue.body || "";

            // 1) Prefer explicit CSV marker line: "CSV: ...."
            let csvLine = "";
            {
              const m = body.match(/^\s*CSV:\s*(.+)\s*$/m);
              if (m && m[1]) csvLine = m[1].trim();
            }

            // 2) Fallback: parse markdown table "| key | value |"
            function unescapePipes(s) { return s.replace(/\\\|/g, "|"); }
            function pickTableValue(key) {
              // matches: | key | value |
              const re = new RegExp("^\\s*\\|\\s*" + key + "\\s*\\|\\s*(.*?)\\s*\\|\\s*$", "mi");
              const m = body.match(re);
              return m && m[1] ? unescapePipes(m[1].trim()) : "";
            }

            function csvEscape(v) {
              v = (v ?? "").toString();
              if (v.includes('"')) v = v.replace(/"/g, '""');
              if (/[,"\r\n]/.test(v)) return `"${v}"`;
              return v;
            }

            if (!csvLine) {
              const timestamp   = pickTableValue("timestamp");
              const language    = pickTableValue("language");
              const player_name = pickTableValue("player_name");
              const Q2_time     = pickTableValue("Q2_time");
              const Q3_time     = pickTableValue("Q3_time");
              const Q4_day      = pickTableValue("Q4_day");

              if (!player_name) {
                core.warning("player_name not found. Skipping.");
                return;
              }

              csvLine = [
                csvEscape(timestamp),
                csvEscape(language),
                csvEscape(player_name),
                csvEscape(Q2_time),
                csvEscape(Q3_time),
                csvEscape(Q4_day),
              ].join(",");
            }

            if (!csvLine) {
              core.warning("CSV line empty. Skipping.");
              return;
            }

            const filePath = "data/answers.csv";
            if (!fs.existsSync("data")) fs.mkdirSync("data", { recursive: true });

            const header = "timestamp,language,player_name,Q2_time,Q3_time,Q4_day\n";
            if (!fs.existsSync(filePath)) fs.writeFileSync(filePath, header, "utf8");

            fs.appendFileSync(filePath, csvLine + "\n", "utf8");
            core.info("Appended: " + csvLine);

      - name: Commit changes
        run: |
          if git status --porcelain | grep .; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add data/answers.csv
            git commit -m "collect: append survey answer"
            git push
          else
            echo "No changes."
          fi
